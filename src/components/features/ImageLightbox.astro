---
interface Props {
  contentSelector?: string;
}

const { contentSelector = 'article[data-entry-content]' } = Astro.props as Props;
---

<div
  data-image-preview-modal
  class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 p-4"
  role="dialog"
  aria-modal="true"
  aria-label="Image preview"
>
  <button
    type="button"
    data-image-preview-close
    class="absolute right-4 top-4 rounded-md bg-white/90 px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-white"
  >
    Close
  </button>
  <img
    data-image-preview-target
    src=""
    alt=""
    class="max-h-[90vh] max-w-[92vw] rounded-xl border border-white/30 object-contain shadow-2xl"
  />
</div>

<script is:inline define:vars={{ contentSelector }}>
  (() => {
    const modal = document.querySelector('[data-image-preview-modal]');
    const closeButton = modal?.querySelector('[data-image-preview-close]');
    const previewImage = modal?.querySelector('[data-image-preview-target]');
    const article = document.querySelector(contentSelector);

    if (
      !(modal instanceof HTMLElement) ||
      !(closeButton instanceof HTMLElement) ||
      !(previewImage instanceof HTMLImageElement) ||
      !(article instanceof HTMLElement)
    ) {
      return;
    }

    const openModal = (src, alt) => {
      previewImage.src = src;
      previewImage.alt = alt || 'Preview image';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    };

    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      previewImage.src = '';
      previewImage.alt = '';
      document.body.style.overflow = '';
    };

    article.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLImageElement)) return;
      if (!target.src) return;
      openModal(target.src, target.alt);
    });

    closeButton.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
  })();
</script>
