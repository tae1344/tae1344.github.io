---
import Layout from '../layouts/Layout.astro';
import ProjectCard from '../components/features/ProjectCard.astro';
import PostCard from '../components/features/PostCard.astro';
import { filePathToSlug, toAbsolutePath, toDate } from '../utils/content';
import mermaid from 'mermaid';

mermaid.initialize({
	startOnLoad: true,
	theme: 'base',
	securityLevel: 'loose',
});

type ProjectItem = {
	slug: string;
	title: string;
	description: string;
	tags: string[];
	thumbnail: string;
	videoUrl?: string;
	date: Date;
	pinned: boolean;
	order?: number;
};

type PostItem = {
	slug: string;
	title: string;
	excerpt: string;
	date: Date;
	readingTime: string;
};

const projectModules = import.meta.glob('../_projects/*.{md,mdx}', { eager: true }) as Record<string, any>;
const postModules = import.meta.glob('../_posts/*.md', { eager: true }) as Record<string, any>;

const projects: ProjectItem[] = Object.entries(projectModules).map(([filePath, mod]) => {
	const fm = mod.frontmatter ?? {};
	return {
		slug: filePathToSlug(filePath),
		title: fm.title ?? 'Untitled Project',
		description: fm.summary ?? fm.description ?? '',
		tags: fm.tags ?? [],
		thumbnail: toAbsolutePath(fm.thumbnail ?? fm.image?.path),
		videoUrl: fm.videoUrl,
		date: toDate(fm.date),
		pinned: Boolean(fm.pinned),
		order: typeof fm.order === 'number' ? fm.order : undefined,
	};
});

const posts: PostItem[] = Object.entries(postModules).map(([filePath, mod]) => {
	const fm = mod.frontmatter ?? {};
	return {
		slug: filePathToSlug(filePath),
		title: fm.title ?? 'Untitled Post',
		excerpt: fm.excerpt ?? fm.summary ?? '',
		date: toDate(fm.date),
		readingTime: fm.readingTime ?? '5 min read',
	};
});

const FALLBACK_ORDER = Number.MAX_SAFE_INTEGER;
const featuredProjects = [...projects]
	.sort((a, b) => {
		const byOrder = (a.order ?? FALLBACK_ORDER) - (b.order ?? FALLBACK_ORDER);
		if (byOrder !== 0) return byOrder;

		const byPinned = Number(b.pinned) - Number(a.pinned);
		if (byPinned !== 0) return byPinned;

		return b.date.valueOf() - a.date.valueOf();
	})
	.slice(0, 6);

const heroProject = featuredProjects[0];
const latestPosts = [...posts].sort((a, b) => b.date.valueOf() - a.date.valueOf()).slice(0, 3);
---

<Layout>
	<main class="mx-auto w-full max-w-6xl px-4 pb-16 pt-8 md:px-8">
		<section class="mb-12 rounded-2xl border border-slate-200 bg-white p-6 md:p-8">
			<p class="mb-2 text-xs uppercase tracking-[0.18em] text-sky-700">Frontend + AI</p>
			<h1 class="mb-3 text-3xl font-extrabold leading-tight text-slate-900 md:text-4xl">
				4년 차 프론트엔드 개발자, AI와 3D 시각화로 사용자 경험의 한계를 넓힙니다.
			</h1>
			<p class="max-w-3xl text-slate-600">
				운영 안정성을 해치지 않으면서도, 제품에 필요한 인터랙션과 실험을 빠르게 검증하는 개발 방식을 지향합니다.
			</p>
			<div class="mt-5 flex flex-wrap gap-3">
				<a href="/about" class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">About me</a>
				<a href="mailto:contact@taekim.dev" class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100">Contact</a>
			</div>
		</section>

		<section id="featured-projects" class="mb-12">
			<div class="mb-5 flex items-end justify-between">
				<h2 class="text-2xl font-bold text-slate-900">Projects</h2>
				<a href="/projects" class="text-sm font-semibold text-sky-700 hover:text-sky-800">View All →</a>
			</div>
			<div class="grid gap-5 md:grid-cols-2 lg:grid-cols-3">
				{featuredProjects.map((project) => (
					<ProjectCard
						title={project.title}
						description={project.description}
						tags={project.tags}
						thumbnail={project.thumbnail || heroProject?.thumbnail || ''}
						videoUrl={project.videoUrl}
						href={`/projects/${project.slug}`}
					/>
				))}
			</div>
		</section>

		<section class="mb-12 grid gap-4 md:grid-cols-2">
			<a href="/about" class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
				<p class="mb-2 text-xs uppercase tracking-[0.14em] text-slate-500">Experience</p>
				<h3 class="mb-2 text-lg font-bold text-slate-900">(주)반려생활 Frontend Lead</h3>
				<p class="mb-4 text-sm text-slate-600">반려생활 앱/웹 프론트엔드 총괄, MAU 12만 성장 기여</p>
				<span class="text-sm font-semibold text-sky-700">자세히 보기 →</span>
			</a>
			<div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<p class="mb-3 text-xs uppercase tracking-[0.14em] text-slate-500">Tech Stack</p>
				<div class="space-y-3">
					<div>
						<p class="mb-1 text-sm font-semibold text-slate-800">FE Core</p>
						<p class="text-sm text-slate-600">React, Next.js, TypeScript, Astro, Tailwind CSS</p>
					</div>
					<div>
						<p class="mb-1 text-sm font-semibold text-slate-800">AI & Data</p>
						<p class="text-sm text-slate-600">RAG, LangChain, Qdrant, Prompt Engineering, 3DGS</p>
					</div>
				</div>
			</div>
		</section>

		<section class="rounded-2xl border border-sky-200 bg-sky-50 p-7 text-center">
			<p class="mb-2 text-lg font-bold text-slate-900">현재 새로운 도전을 찾고 있습니다.</p>
			<p class="mb-4 text-slate-600">제품 문제를 함께 정의하고 해결할 팀을 기다리고 있습니다.</p>
			<a href="mailto:contact@taekim.dev" class="inline-block rounded-lg bg-sky-700 px-5 py-2 text-sm font-semibold text-white hover:bg-sky-800">
				contact@taekim.dev
			</a>
		</section>
	</main>
</Layout>
